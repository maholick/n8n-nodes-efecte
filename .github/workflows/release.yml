name: Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - '.github/workflows/**'
      - '.editorconfig'
      - '.eslintrc*'
      - '.gitignore'
      - '.npmignore'
      - '.prettierrc*'
      - 'tslint.json'
      - 'tsconfig.json'
      - 'README.md'
      - 'LICENSE.md'
      - 'CODE_OF_CONDUCT.md'
      - 'CHANGELOG.md'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Check if package.json changed
      id: check_package_json
      if: github.event_name != 'workflow_dispatch'
      run: |
        if git diff --name-only HEAD~1 HEAD | grep -q "^package.json$"; then
          echo "package_json_changed=true" >> $GITHUB_OUTPUT
          echo "package.json was modified"
        else
          echo "package_json_changed=false" >> $GITHUB_OUTPUT
          echo "package.json was not modified - skipping release"
        fi

    - name: Setup Node.js
      if: |
        github.event_name == 'workflow_dispatch' ||
        steps.check_package_json.outputs.package_json_changed == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '22.12.0'

    - name: Install pnpm
      if: |
        github.event_name == 'workflow_dispatch' ||
        steps.check_package_json.outputs.package_json_changed == 'true'
      uses: pnpm/action-setup@v2
      with:
        version: 9.1.4

    - name: Install dependencies
      if: |
        github.event_name == 'workflow_dispatch' ||
        steps.check_package_json.outputs.package_json_changed == 'true'
      run: pnpm install --no-frozen-lockfile

    - name: Run linter
      if: |
        github.event_name == 'workflow_dispatch' ||
        steps.check_package_json.outputs.package_json_changed == 'true'
      run: pnpm run lint

    - name: Build project
      if: |
        github.event_name == 'workflow_dispatch' ||
        steps.check_package_json.outputs.package_json_changed == 'true'
      run: pnpm run build

    - name: Get version from package.json
      if: |
        github.event_name == 'workflow_dispatch' ||
        steps.check_package_json.outputs.package_json_changed == 'true'
      id: package-version
      uses: martinbeentjes/npm-get-version-action@v1.3.1

    - name: Check if version has changed
      if: |
        github.event_name == 'workflow_dispatch' ||
        steps.check_package_json.outputs.package_json_changed == 'true'
      id: check_version
      run: |
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
        CURRENT_VERSION="${{ steps.package-version.outputs.current-version }}"
        echo "Latest tag: $LATEST_TAG"
        echo "Current version: $CURRENT_VERSION"
        echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        if [ "$LATEST_TAG" != "$CURRENT_VERSION" ]; then
          echo "Version has changed - will create release"
          echo "version_changed=true" >> $GITHUB_OUTPUT
        else
          echo "Version unchanged - skipping release"
          echo "version_changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Generate Release Notes
      if: steps.check_version.outputs.version_changed == 'true'
      id: release_notes
      run: |
        LATEST_TAG="${{ steps.check_version.outputs.latest_tag }}"
        CURRENT_VERSION="${{ steps.check_version.outputs.current_version }}"
        
        # Generate release notes from git commits
        if [ "$LATEST_TAG" = "0.0.0" ]; then
          # First release - get all commits
          COMMITS=$(git log --pretty=format:"- %s" --reverse)
        else
          # Get commits since last tag
          COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"- %s" --reverse)
        fi
        
        # Create release notes using heredoc for multiline output
        {
          echo "notes<<EOF"
          echo "## Release $CURRENT_VERSION"
          echo ""
          echo "### Changes"
          echo "$COMMITS"
          echo ""
          echo "---"
          echo ""
          echo "See [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details."
          echo "EOF"
        } >> $GITHUB_OUTPUT

    - name: Create Git Tag and Release
      if: steps.check_version.outputs.version_changed == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION="${{ steps.check_version.outputs.current_version }}"
        echo "Creating release for version: $VERSION"
        
        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Create and push tag
        git tag -a "$VERSION" -m "Release $VERSION"
        git push origin "$VERSION"
        
        # Create GitHub release with generated notes
        gh release create "$VERSION" \
          --title "Release $VERSION" \
          --notes "${{ steps.release_notes.outputs.notes }}"
